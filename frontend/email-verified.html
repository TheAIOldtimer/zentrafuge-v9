<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verified - Zentrafuge v9</title>
    
    <!-- Favicon and app icons -->
    <link rel="icon" type="image/png" href="assets/Zentrafuge-WIDE-Logo-Transparent.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- SEO and social -->
    <meta name="description" content="Email verified successfully - Welcome to Zentrafuge v9">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    
    <style>
        .verification-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-lg);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            text-align: center;
        }
        
        .verification-card {
            background: var(--bg-primary);
            padding: var(--space-2xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            max-width: 500px;
            width: 100%;
            animation: slideUp 0.6s ease-out;
        }
        
        .logo {
            width: 150px;
            height: auto;
            margin-bottom: var(--space-xl);
        }
        
        .success-icon {
            font-size: 4rem;
            margin-bottom: var(--space-lg);
            animation: bounceIn 0.8s ease-out;
        }
        
        .success-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: var(--space-md);
            color: var(--text-primary);
        }
        
        .success-message {
            color: var(--text-secondary);
            margin-bottom: var(--space-lg);
            line-height: 1.6;
        }
        
        .cael-welcome {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            margin: var(--space-lg) 0;
            font-style: italic;
            position: relative;
        }
        
        .cael-welcome::before {
            content: '"';
            font-size: 2rem;
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            opacity: 0.5;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            margin-top: var(--space-xl);
        }
        
        .loading-state,
        .error-state {
            text-align: center;
            padding: var(--space-lg);
        }
        
        .loading-state {
            display: none;
        }
        
        .error-state {
            display: none;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: var(--radius-md);
            color: #dc2626;
        }
        
        .error-state strong {
            display: block;
            margin-bottom: var(--space-sm);
        }
        
        @media (max-width: 480px) {
            .verification-container {
                padding: var(--space-md);
            }
            
            .verification-card {
                padding: var(--space-xl);
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="verification-container">
        <div class="verification-card">
            <img src="assets/Zentrafuge-WIDE-Logo-Transparent.png" alt="Zentrafuge Logo" class="logo">
            
            <!-- Success State -->
            <div id="success-state">
                <div class="success-icon">âœ…</div>
                <h1 class="success-title">Email Verified Successfully!</h1>
                <p class="success-message">
                    Welcome to Zentrafuge v9! Your email has been verified and your account is now active.
                </p>
                
                <div class="cael-welcome">
                    Hello! I'm Cael, your AI companion. I'm excited to meet you and learn about your unique perspective. 
                    Together, we'll build a meaningful relationship based on understanding, growth, and genuine connection.
                </div>
                
                <div class="action-buttons">
                    <a href="index.html" class="btn btn-primary" id="start-onboarding">
                        Start My Journey with Cael
                    </a>
                    <a href="index.html" class="btn btn-secondary" id="login-instead">
                        Go to Login
                    </a>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="loading-state" class="loading-state">
                <div class="loading-spinner"></div>
                <p>Setting up your account...</p>
            </div>
            
            <!-- Error State -->
            <div id="error-state" class="error-state">
                <strong>Verification Error</strong>
                <p>There was an issue verifying your email. Please try logging in or contact support if the problem persists.</p>
                <div class="action-buttons">
                    <a href="index.html" class="btn btn-primary">Try Logging In</a>
                    <a href="mailto:support@zentrafuge.com" class="btn btn-secondary">Contact Support</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="firebase.js"></script>
    <script>
        // Email Verification Handler
        class EmailVerificationHandler {
            constructor() {
                this.init();
            }
            
            async init() {
                try {
                    // Check for verification parameters in URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const mode = urlParams.get('mode');
                    const oobCode = urlParams.get('oobCode');
                    const continueUrl = urlParams.get('continueUrl');
                    
                    if (mode === 'verifyEmail' && oobCode) {
                        await this.handleEmailVerification(oobCode);
                    } else {
                        // No verification code, show success (user might have clicked link after already being verified)
                        this.showSuccess();
                    }
                } catch (error) {
                    console.error('Email verification error:', error);
                    this.showError(error.message);
                }
            }
            
            async handleEmailVerification(actionCode) {
                try {
                    this.showLoading();
                    
                    // Apply the email verification code
                    await firebase.auth().applyActionCode(actionCode);
                    
                    // Check if user is signed in
                    const user = firebase.auth().currentUser;
                    if (user) {
                        // Reload user to get updated emailVerified status
                        await user.reload();
                        
                        if (user.emailVerified) {
                            this.showSuccess();
                            this.updateUserProfile(user);
                        } else {
                            throw new Error('Email verification did not complete properly');
                        }
                    } else {
                        // User not signed in, but verification was successful
                        this.showSuccess();
                    }
                    
                } catch (error) {
                    console.error('Email verification failed:', error);
                    this.showError(this.getErrorMessage(error));
                }
            }
            
            async updateUserProfile(user) {
                try {
                    // Send verification status to backend if needed
                    const token = await user.getIdToken();
                    
                    // You could call your backend here to update user status
                    // await this.notifyBackendOfVerification(token);
                    
                } catch (error) {
                    console.error('Profile update error:', error);
                    // Don't show error to user, verification was successful
                }
            }
            
            showLoading() {
                document.getElementById('success-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('loading-state').style.display = 'block';
            }
            
            showSuccess() {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('success-state').style.display = 'block';
            }
            
            showError(message) {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('success-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                
                const errorMessageEl = document.querySelector('#error-state p');
                if (errorMessageEl) {
                    errorMessageEl.textContent = message;
                }
            }
            
            getErrorMessage(error) {
                const errorMessages = {
                    'auth/expired-action-code': 'This verification link has expired. Please request a new one.',
                    'auth/invalid-action-code': 'This verification link is invalid. Please check your email for the correct link.',
                    'auth/user-disabled': 'This account has been disabled. Please contact support.',
                    'auth/user-not-found': 'No account found with this email address.',
                    'auth/invalid-action-code': 'Invalid verification code. Please try again.'
                };
                
                return errorMessages[error.code] || error.message || 'Email verification failed. Please try again.';
            }
        }
        
        // Initialize when Firebase is ready
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof firebase !== 'undefined') {
                firebase.auth().onAuthStateChanged(function(user) {
                    // Initialize verification handler
                    new EmailVerificationHandler();
                });
            } else {
                console.error('Firebase not loaded');
                document.querySelector('.error-state').style.display = 'block';
            }
        });
        
        // Button click handlers
        document.addEventListener('click', function(e) {
            if (e.target.id === 'start-onboarding') {
                // Add onboarding flag to URL
                e.preventDefault();
                window.location.href = 'index.html?verified=true&onboard=true';
            }
        });
    </script>
</body>
</html>
